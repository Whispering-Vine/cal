<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Your existing CSS styles */
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-button"><i class="fas fa-arrow-left"></i>Events</a>
        <div class="timezone">UTC -8 America/Los_Angeles</div>
        <div class="not-found" id="not-found" style="display: none;">
            <h1>404 - Event Not Found</h1>
            <p>The event you are looking for does not exist or has been moved.</p>
        </div>
        <div id="event-details">
            <h1 id="event-title">Trefethen Wine Tasting</h1>
            <div class="event-date">
                <div class="calendar-icon">
                    <div class="day" id="event-day">14</div>
                    <div id="event-month">AUG</div>
                </div>
                <div class="event-info">
                    <div id="event-day-name">Wednesday</div>
                    <div id="event-full-date">Aug 14, 2024</div>
                    <div id="event-time">4:00 PM - 7:00 PM</div>
                </div>
            </div>
            <div class="event-location" id="event-location">
                <i class="fas fa-map-marker-alt"></i> 85 Foothill Rd. Ste 1 Reno, NV 89511
            </div>
            <div class="event-note" id="event-description">
                Buy any Trefethen bottle from the tasting and the tasting fee will be refunded.
            </div>
            <div class="add-to-calendar">
                <h2>Add to Calendar</h2>
                <div class="calendar-buttons">
                    <a href="#" class="calendar-button" id="google-link"><i class="fab fa-google"></i> Google</a>
                    <a href="#" class="calendar-button" id="apple-link" onclick="openInNewTab('ics')"><i class="fab fa-apple"></i> Apple</a>
                    <a href="#" class="calendar-button" id="outlook-link"><i class="fas fa-envelope"></i> Outlook</a>
                    <a href="#" class="calendar-button" id="yahoo-link"><i class="fab fa-yahoo"></i> Yahoo</a>
                    <a href="#" class="calendar-button" id="office365-link"><i class="fab fa-microsoft"></i> Office365</a>
                    <a href="#" class="calendar-button" id="ics-link" onclick="openInNewTab('ics')"><i class="fas fa-calendar-alt"></i> ICS File</a>
                </div>
            </div>
        </div>
    </div>
    <script>
        // Function to generate unique UID for the event
        const generateUID = () => {
            return [...Array(32)].map(() => Math.floor(Math.random() * 16).toString(16)).join('');
        };

        // Function to format date and time in the required format
        const formatDateTime = (dateTime) => {
            const date = new Date(dateTime);
            return date.toISOString().replace(/[-:]/g, '').slice(0, -5) + 'Z';
        };

        // Function to generate ICS file content
        const generateICSFile = (event) => {
            const { title, description, location, startTime, endTime } = event;

            // Generate unique UID
            const uid = generateUID();

            // Format start and end times
            const formattedStartTime = formatDateTime(startTime);
            const formattedEndTime = formatDateTime(endTime);
            const formattedNow = formatDateTime(new Date().toISOString());

            // Escape special characters and replace newlines for ICS format
            const escapedDescription = description.replace(/[\n\r]+/g, '\\n').replace(/[,;]/g, '\\$&');
            const escapedLocation = location.replace(/[,;]/g, '\\$&');

            return `BEGIN:VCALENDAR
VERSION:2.0
PRODID:Whispering Vine
BEGIN:VEVENT
UID:${uid}
DTSTAMP:${formattedNow}
DTSTART:${formattedStartTime}
DTEND:${formattedEndTime}
DESCRIPTION:${escapedDescription}
LOCATION:${escapedLocation}
SUMMARY:${title}
END:VEVENT
END:VCALENDAR`;
        };

        // Function to fetch event data from GitHub
        const fetchEventData = async (eventId) => {
            try {
                const response = await fetch(`https://raw.githubusercontent.com/Whispering-Vine/cal/main/events/${eventId}.json`);
                if (!response.ok) throw new Error('Event not found');
                return await response.json();
            } catch (error) {
                console.error('Error fetching event data:', error);
                return null;
            }
        };

        // Function to generate calendar URLs
        const generateCalendarUrls = (event) => {
            const { title, description, location, startTime, endTime } = event;

            const formattedTitle = encodeURIComponent(title);
            const formattedDescription = encodeURIComponent(description);
            const formattedLocation = encodeURIComponent(location);

            return {
                yahoo: `https://calendar.yahoo.com/?v=60&view=d&type=20&ST=${startTime}&ET=${endTime}&TITLE=${formattedTitle}&DESC=${formattedDescription}&in_loc=${formattedLocation}`,
                google: `https://calendar.google.com/calendar/u/0/r/eventedit?dates=${startTime}/${endTime}&ctz=America/Los_Angeles&text=${formattedTitle}&details=${formattedDescription}&location=${formattedLocation}`,
                outlook: `https://outlook.live.com/owa/?path=/calendar/action/compose&rru=addevent&startdt=${startTime}&enddt=${endTime}&subject=${formattedTitle}&body=${formattedDescription}&location=${formattedLocation}`,
                office365: `https://outlook.office365.com/calendar/action/compose?startdt=${startTime}&enddt=${endTime}&subject=${formattedTitle}&body=${formattedDescription}&location=${formattedLocation}`,
                apple: 'javascript:void(0);' // Placeholder for Apple Calendar
            };
        };

        // Function to open Blob URL in a new tab
        const openInNewTab = (type) => {
            const eventId = window.location.pathname.split('/').pop(); // Get event ID from URL
            fetchEventData(eventId).then(event => {
                if (event) {
                    if (type === 'ics') {
                        const icsContent = generateICSFile(event);
                        const blob = new Blob([icsContent], { type: 'text/calendar' });
                        const url = URL.createObjectURL(blob);

                        // Open Blob URL in a new tab
                        window.open(url, '_blank');
                        URL.revokeObjectURL(url);
                    } else if (type === 'apple') {
                        // Use the same Blob approach for Apple Calendar
                        const icsContent = generateICSFile(event);
                        const blob = new Blob([icsContent], { type: 'text/calendar' });
                        const url = URL.createObjectURL(blob);

                        // Open Blob URL in a new tab for Apple Calendar
                        window.open(url, '_blank');
                        URL.revokeObjectURL(url);
                    }
                }
            });
        };

        // Main script to initialize the event page
        (async () => {
            const eventId = window.location.pathname.split('/').pop(); // Get event ID from URL
            const eventData = await fetchEventData(eventId);

            if (eventData) {
                document.getElementById('event-title').textContent = eventData.title;
                document.getElementById('event-day').textContent = new Date(eventData.startTime).getDate();
                document.getElementById('event-month').textContent = new Date(eventData.startTime).toLocaleString('default', { month: 'short' }).toUpperCase();
                document.getElementById('event-day-name').textContent = new Date(eventData.startTime).toLocaleString('default', { weekday: 'long' });
                document.getElementById('event-full-date').textContent = new Date(eventData.startTime).toLocaleDateString();
                document.getElementById('event-time').textContent = `${new Date(eventData.startTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })} - ${new Date(eventData.endTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
                document.getElementById('event-location').textContent = eventData.location;
                document.getElementById('event-description').textContent = eventData.description;

                // Generate calendar URLs
                const calendarUrls = generateCalendarUrls(eventData);
                document.getElementById('google-link').href = calendarUrls.google;
                document.getElementById('apple-link').href = 'javascript:void(0);'; // Placeholder for Apple Calendar
                document.getElementById('outlook-link').href = calendarUrls.outlook;
                document.getElementById('yahoo-link').href = calendarUrls.yahoo;
                document.getElementById('office365-link').href = calendarUrls.office365;
                document.getElementById('ics-link').href = 'javascript:void(0);'; // Placeholder for ICS file
            } else {
                document.getElementById('not-found').style.display = 'block';
                document.getElementById('event-details').style.display = 'none';
            }
        })();
    </script>
</body>
</html>
