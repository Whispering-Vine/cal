<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Event</title>
  <link rel="icon" href="favicon.png" type="image/png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Tag Manager -->
  <script>
    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-T57JWWVK');
  </script>
  <!-- End Google Tag Manager -->
  <style>
    :root { --background:#f8f9fa; --foreground:#1f2937; --muted:#e5e7eb; }
    .bg-background{background-color:var(--background);}
    .text-foreground{color:var(--foreground);}
    .bg-muted{background-color:var(--muted);}
  </style>
</head>
<body class="bg-background text-foreground">
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-T57JWWVK" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->
  <div class="container mx-auto max-w-xl bg-white shadow rounded-xl p-6 mt-14 relative">
    <a href="https://cal.wvwine.co" class="absolute top-4 left-4 text-sm text-gray-600 hover:text-gray-800"><i class="fas fa-arrow-left mr-1"></i>Events</a>
    <div class="absolute top-4 right-4 text-xs bg-gray-100 px-3 py-1 rounded-full">UTC -8 America/Los_Angeles</div>

    <div id="skeleton-details" class="space-y-4 animate-pulse">
      <div class="h-8 bg-muted rounded w-3/4"></div>
      <div class="h-6 bg-muted rounded w-1/2"></div>
      <div class="h-4 bg-muted rounded w-full"></div>
      <div class="h-24 bg-muted rounded w-full"></div>
    </div>

    <div id="event-details" class="hidden">
      <h1 id="event-title" class="text-2xl font-semibold mb-4"></h1>
      <div class="flex items-center mb-4">
        <div class="calendar-icon bg-black text-white w-14 h-14 flex flex-col justify-center items-center font-bold rounded mr-4">
          <div class="day" id="event-day"></div>
          <div id="event-month"></div>
        </div>
        <div class="space-y-1">
          <div id="event-day-name"></div>
          <div id="event-full-date"></div>
          <div id="event-time"></div>
        </div>
      </div>
      <div class="event-location mb-4" id="event-location"></div>
      <div class="event-note mb-4" id="event-description"></div>
      <div class="add-to-calendar mt-6">
        <h2 class="text-lg font-semibold mb-2">Add to Calendar</h2>
        <div class="grid grid-cols-3 gap-2 text-sm">
          <a href="#" class="calendar-button bg-gray-100 p-2 rounded text-center" id="google-link"><i class="fab fa-google mr-1"></i>Google</a>
          <a href="#" class="calendar-button bg-gray-100 p-2 rounded text-center" id="apple-link" onclick="redirectToAppleCalendar(event)"><i class="fab fa-apple mr-1"></i>Apple</a>
          <a href="#" class="calendar-button bg-gray-100 p-2 rounded text-center" id="outlook-link"><i class="fas fa-envelope mr-1"></i>Outlook</a>
          <a href="#" class="calendar-button bg-gray-100 p-2 rounded text-center" id="yahoo-link"><i class="fab fa-yahoo mr-1"></i>Yahoo</a>
          <a href="#" class="calendar-button bg-gray-100 p-2 rounded text-center" id="office365-link"><i class="fab fa-microsoft mr-1"></i>Office365</a>
          <a href="#" class="calendar-button bg-gray-100 p-2 rounded text-center" id="ics-link"><i class="fas fa-calendar-alt mr-1"></i>ICS File</a>
        </div>
      </div>
    </div>

    <div class="not-found text-center hidden" id="not-found">
      <h1 class="text-2xl font-semibold mb-2">404 - Event Not Found</h1>
      <p>The event you are looking for does not exist or has been moved.</p>
    </div>

    <div class="rsvp-container mt-6" id="rsvp-container">
      <div class="limited-seats flex items-center justify-between text-sm font-bold text-orange-700 mb-4">
        <h2 class="text-xl">RSVP Here</h2>
        <div><i class="fas fa-users"></i> Limited seats</div>
      </div>
      <p><strong>Are you attending this event?</strong></p>
      <div class="attendance-options flex gap-2 my-2">
        <input type="radio" id="attend-yes" name="attendance" value="yes" checked>
        <label for="attend-yes" class="flex-1 text-center border-2 border-gray-300 rounded-md py-2 cursor-pointer">Yes</label>
        <input type="radio" id="attend-maybe" name="attendance" value="maybe">
        <label for="attend-maybe" class="flex-1 text-center border-2 border-gray-300 rounded-md py-2 cursor-pointer">Maybe</label>
        <input type="radio" id="attend-no" name="attendance" value="no">
        <label for="attend-no" class="flex-1 text-center border-2 border-gray-300 rounded-md py-2 cursor-pointer">No</label>
      </div>
      <label class="rsvp-label block font-bold mt-2" for="name">Full Name</label>
      <input type="text" id="name" placeholder="Enter your name" class="w-full border rounded p-2 mb-2">
      <label class="rsvp-label block font-bold" for="email">Email</label>
      <input type="email" id="email" placeholder="Enter your email" class="w-full border rounded p-2 mb-4">
      <button class="register-button w-full bg-black text-white rounded py-3 font-semibold" type="submit" id="register-btn">Register</button>
    </div>

  </div>
<script>
  const generateUID = () => {
      return [...Array(32)].map(() => Math.floor(Math.random() * 16).toString(16)).join('');
  };
  const formatDateTime = (dateTime) => {
      const date = new Date(dateTime);
      return date.toISOString().replace(/[-:]/g, '').slice(0, -5) + 'Z';
  };
  const htmlToPlainText = (html) => {
      const doc = new DOMParser().parseFromString(html, 'text/html');
      const body = doc.body;
      body.querySelectorAll('br').forEach(br => br.replaceWith('\n'));
      body.querySelectorAll('p').forEach(p => p.replaceWith('\n' + p.textContent + '\n'));
      body.querySelectorAll('ol').forEach(ol => {
          const items = Array.from(ol.querySelectorAll('li'))
              .map((li, index) => `${index + 1}. ${li.textContent}`)
              .join('\n');
          ol.replaceWith('\n' + items + '\n');
      });
      body.querySelectorAll('ul').forEach(ul => {
          const items = Array.from(ul.querySelectorAll('li'))
              .map(li => `- ${li.textContent}`)
              .join('\n');
          ul.replaceWith('\n' + items + '\n');
      });
      body.querySelectorAll('a').forEach(a => {
          const text = a.textContent;
          const url = a.getAttribute('href');
          a.replaceWith(`${text}: ${url}`);
      });
      return body.textContent.trim().replace(/\n\s*\n/g, '\n\n');
  };
  const escapeICSContent = (content) => {
      return content
          .replace(/[\n\r]+/g, '\n')
          .replace(/\t/g, '\t')
          .replace(/[,;]/g, '\$&');
  };
  const generateICSFile = (event) => {
      const { title, description, location, startTime, endTime } = event;
      const uid = generateUID();
      const formattedStartTime = formatDateTime(startTime);
      const formattedEndTime = formatDateTime(endTime);
      const formattedNow = formatDateTime(new Date().toISOString());
      const plainTextDescription = htmlToPlainText(description);
      const cleanDescription = escapeICSContent(plainTextDescription);
      const escapedLocation = location.replace(/[,;]/g, '\$&');
      return `BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:Whispering Vine\nBEGIN:VEVENT\nUID:${uid}\nDTSTAMP:${formattedNow}\nDTSTART:${formattedStartTime}\nDTEND:${formattedEndTime}\nDESCRIPTION:${cleanDescription}\nLOCATION:${escapedLocation}\nSUMMARY:${title}\nEND:VEVENT\nEND:VCALENDAR`;
  };
  const fetchEventData = async (eventId) => {
      try {
          const response = await fetch(`https://cal.wvwine.co/events/${eventId}.json`);
          if (!response.ok) throw new Error('Event not found');
          return await response.json();
      } catch (error) {
          console.error('Error fetching event data:', error);
          return null;
      }
  };
  const generateCalendarUrls = (event) => {
      const { title, description, location, startTime, endTime } = event;
      const formattedTitle = encodeURIComponent(title);
      const formattedDescription = encodeURIComponent(description);
      const formattedLocation = encodeURIComponent(location);
      const formatGoogleDate = (dateTime) => {
          const date = new Date(dateTime);
          const isoString = date.toISOString();
          return isoString.replace(/[-:]/g, '').split('.')[0] + 'Z';
      };
      const formatOutlookDate = (dateTime) => {
          const date = new Date(dateTime);
          return date.toISOString().replace(/:/g, '%3a');
      };
      const formatOffice365Date = (dateTime) => {
          const date = new Date(dateTime);
          return date.toISOString();
      };
      const startDateGoogle = formatGoogleDate(startTime);
      const endDateGoogle = formatGoogleDate(endTime);
      const startDateOutlook = formatOutlookDate(startTime);
      const endDateOutlook = formatOutlookDate(endTime);
      const startDateOffice365 = formatOffice365Date(startTime);
      const endDateOffice365 = formatOffice365Date(endTime);
      const startDateYahoo = formatGoogleDate(startTime);
      const endDateYahoo = formatGoogleDate(endTime);
      return {
          yahoo: `https://calendar.yahoo.com/?v=60&view=d&type=20&ST=${startDateYahoo}&ET=${endDateYahoo}&TITLE=${formattedTitle}&DESC=${formattedDescription}&in_loc=${formattedLocation}`,
          google: `https://calendar.google.com/calendar/u/0/r/eventedit?dates=${startDateGoogle}/${endDateGoogle}&ctz=America/Los_Angeles&text=${formattedTitle}&details=${formattedDescription}&location=${formattedLocation}`,
          outlook: `https://outlook.live.com/calendar/0/action/compose/?path=%2fcalendar%2faction%2fcompose&rru=addevent&startdt=${startDateOutlook}&enddt=${endDateOutlook}&subject=${formattedTitle}&body=${formattedDescription}&location=${formattedLocation}`,
          office365: `https://outlook.office.com/calendar/deeplink/compose?path=/calendar/action/compose&rru=addevent&startdt=${startDateOffice365}&enddt=${endDateOffice365}&subject=${formattedTitle}&body=${formattedDescription}&location=${formattedLocation}`
      };
  };
  const showNotFound = () => {
      document.getElementById('event-details').style.display = 'none';
      document.getElementById('not-found').style.display = 'block';
      document.getElementById('rsvp-container').style.display = 'none';
      document.getElementById('skeleton-details').style.display = 'none';
  };
  const updateEventDetails = (event) => {
      document.title = event.title;
      document.getElementById('event-title').textContent = event.title;
      document.getElementById('event-description').innerHTML = event.description;
      document.getElementById('event-location').textContent = "📍" + event.location;
      const startDate = new Date(event.startTime);
      const endDate = new Date(event.endTime);
      document.getElementById('event-day').textContent = startDate.getDate();
      document.getElementById('event-month').textContent = startDate.toLocaleString('default', { month: 'short' }).toUpperCase();
      document.getElementById('event-day-name').textContent = startDate.toLocaleString('default', { weekday: 'long' });
      document.getElementById('event-full-date').textContent = startDate.toLocaleString('default', { month: 'short', day: 'numeric', year: 'numeric' });
      document.getElementById('event-time').textContent = `${startDate.toLocaleTimeString([], {hour: 'numeric', minute:'2-digit'})} - ${endDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
  };
  const redirectToAppleCalendar = (event) => {
      event.preventDefault();
      const eventId = window.location.pathname.split('/').pop();
      if (!eventId) return;
      window.location.href = `https://cal.wvwine.co/events/${eventId}.ics`;
  };
  const downloadICS = (event) => {
      event.preventDefault();
      const eventId = window.location.pathname.split('/').pop();
      if (!eventId) return;
      fetchEventData(eventId).then(event => {
          if (!event) return;
          const icsContent = generateICSFile(event);
          const blob = new Blob([icsContent], { type: 'text/calendar' });
          const icsBlobUrl = URL.createObjectURL(blob);
          const tempLink = document.createElement('a');
          tempLink.href = icsBlobUrl;
      });
  };
  (async () => {
      try {
          let eventId = window.location.pathname.split('/').pop();
          if (!eventId) throw new Error('No event ID provided in the URL');
          if (eventId === 'RJoA5p') {
              eventId = 'JdlUAs';
          }
          const event = await fetchEventData(eventId);
          if (!event) throw new Error('Event not found');
          updateEventDetails(event);
          const urls = generateCalendarUrls(event);
          const icsContent = generateICSFile(event);
          const blob = new Blob([icsContent], { type: 'text/calendar' });
          const icsBlobUrl = URL.createObjectURL(blob);
          const icsLink = document.getElementById('ics-link');
          icsLink.href = icsBlobUrl;
          icsLink.download = `${event.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.ics`;
          document.getElementById('yahoo-link').href = urls.yahoo;
          document.getElementById('google-link').href = urls.google;
          document.getElementById('outlook-link').href = urls.outlook;
          document.getElementById('office365-link').href = urls.office365;
          document.getElementById('event-details').style.display = 'block';
          document.getElementById('not-found').style.display = 'none';
          document.getElementById('skeleton-details').style.display = 'none';
          if (event.tock === true) {
              document.getElementById('rsvp-container').style.display = 'none';
          } else {
              document.getElementById('rsvp-container').style.display = 'block';
          }
      } catch (error) {
          console.error('Error fetching event data:', error);
          showNotFound();
      }
  })();
  document.querySelector('#register-btn').addEventListener('click', async function(event) {
      event.preventDefault();
      const registerBtn = document.getElementById('register-btn');
      const nameInput = document.getElementById('name');
      const emailInput = document.getElementById('email');
      const attendance = document.querySelector('input[name="attendance"]:checked').value;
      const eventId = window.location.pathname.split('/').pop();
      let isValid = true;
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      nameInput.classList.remove('error');
      emailInput.classList.remove('error');
      if (!nameInput.value.trim()) {
          nameInput.classList.add('error');
          isValid = false;
      }
      if (!emailInput.value.trim() || !emailRegex.test(emailInput.value.trim())) {
          emailInput.classList.add('error');
          isValid = false;
      }
      if (!isValid) return;
      registerBtn.textContent = 'Loading...';
      registerBtn.disabled = true;
      try {
          const response = await fetch('https://admin.wvwine.co/api/rsvp', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ name: nameInput.value, email: emailInput.value, attendance, eventId })
          });
          const result = await response.json();
          if (response.ok) {
              const eventName = document.getElementById('event-title')?.textContent || 'the event';
              let message = '';
              if (attendance === 'yes') {
                  message = `You are attending ${eventName}!`;
              } else if (attendance === 'maybe') {
                  message = `You're interested in ${eventName}.`;
              } else if (attendance === 'no') {
                  message = `You are not attending ${eventName}.`;
              }
              const rsvpFormContainer = document.getElementById('rsvp-container');
              rsvpFormContainer.classList.add('fade-out');
              setTimeout(() => {
                  rsvpFormContainer.innerHTML = `<h3>${message}</h3>`;
                  rsvpFormContainer.style.opacity = '1';
              }, 500);
          } else {
              registerBtn.textContent = 'Error';
              setTimeout(() => {
                  registerBtn.textContent = 'Register';
                  registerBtn.disabled = false;
              }, 2000);
          }
      } catch (error) {
          console.error('Error submitting RSVP:', error);
          registerBtn.textContent = 'Error';
          setTimeout(() => {
              registerBtn.textContent = 'Register';
              registerBtn.disabled = false;
          }, 2000);
      }
  });
</script>
</body>
</html>
